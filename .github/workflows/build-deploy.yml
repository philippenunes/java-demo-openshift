# ðŸš€ GITHUB ACTIONS - PIPELINE CI/CD COMPLETO
# Workflow de testes, build e deploy via GitOps no OpenShift

name: ðŸ—ï¸ Build and Deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'pom.xml'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx1024m'
  PROJECT_NAME: 'my-java-app'
  NAMESPACE: 'philippenunes-dev'

jobs:
  # ðŸ§ª TESTES E VALIDAÃ‡Ã•ES
  test:
    name: ðŸ§ª Tests & Quality Gates
    runs-on: self-hosted
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven

    - name: ðŸ§ª Run Tests
      shell: pwsh
      run: |
        Write-Host "ðŸ§ª Running unit tests..."
        mvn test
        Write-Host "âœ… Tests completed successfully!"

    - name: âœ… Code Coverage
      shell: pwsh
      run: |
        Write-Host "ðŸ“Š Generating coverage report..."
        try {
          mvn jacoco:report
        } catch {
          Write-Host "ðŸ“ Coverage plugin not configured"
        }

  # ðŸ—ï¸ BUILD NO OPENSHIFT
  build:
    name: ðŸ—ï¸ OpenShift Build
    runs-on: self-hosted
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: âœ… Verify Environment
      shell: pwsh
      run: |
        Write-Host "âœ… Verifying self-hosted environment..."
        if (Get-Command oc -ErrorAction SilentlyContinue) {
          Write-Host "âœ… OpenShift CLI found"
          try {
            $server = oc whoami --show-server
            Write-Host "âœ… Connected to OpenShift server: $server"
          } catch {
            Write-Host "âš ï¸ Not logged into OpenShift"
          }
        } else {
          Write-Host "âŒ OpenShift CLI not found"
        }

    - name: ðŸ” OpenShift Login
      shell: pwsh
      run: |
        if (-not $env:OPENSHIFT_TOKEN -or -not $env:OPENSHIFT_SERVER) {
          Write-Host "âš ï¸ OPENSHIFT_TOKEN or OPENSHIFT_SERVER not set. Skipping login."
          exit 0
        }
        Write-Host "ðŸ” Logging into OpenShift..."
        oc login --token=$env:OPENSHIFT_TOKEN --server=$env:OPENSHIFT_SERVER --insecure-skip-tls-verify
        $user = oc whoami
        Write-Host "âœ… Logged in as $user"

    - name: ðŸ—ï¸ Trigger Build
      shell: pwsh
      run: |
        Write-Host "ðŸ—ï¸ Starting OpenShift build..."
        Write-Host "Project: $env:PROJECT_NAME"
        Write-Host "Namespace: $env:NAMESPACE"

        try {
          oc get namespace $env:NAMESPACE | Out-Null
        } catch {
          Write-Host "âš ï¸ Namespace $env:NAMESPACE may not exist"
        }

        try {
          oc get buildconfig $env:PROJECT_NAME -n $env:NAMESPACE | Out-Null
        } catch {
          Write-Host "âš ï¸ BuildConfig $env:PROJECT_NAME may not exist"
        }

        oc start-build $env:PROJECT_NAME -n $env:NAMESPACE --follow --wait

    - name: ðŸ“¦ Get Latest Image
      id: image
      shell: pwsh
      run: |
        Write-Host "ðŸ“¦ Getting latest build digest..."
        $build = oc get builds -n $env:NAMESPACE --sort-by=.metadata.creationTimestamp -o json | ConvertFrom-Json
        $latestBuild = $build.items[-1].metadata.name
        Write-Host "Latest build: $latestBuild"
        "build_number=$latestBuild" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

    - name: âœ… Build Success Notification
      shell: pwsh
      run: |
        Write-Host "âœ… Build completed successfully!"
        Write-Host "ðŸ—ï¸ Build: $($env:GITHUB_OUTPUT)"
        Write-Host "ðŸŽ¯ Next: ArgoCD Image Updater will detect and deploy automatically"

  # ðŸ“Š DEPLOYMENT STATUS
  status:
    name: ðŸ“Š Deployment Status
    runs-on: self-hosted
    needs: build
    if: always()
    steps:
    - name: ðŸ“Š Pipeline Summary
      shell: pwsh
      run: |
        "`n## ðŸš€ Pipeline Summary`" >> $env:GITHUB_STEP_SUMMARY
        "`n| Stage | Status |`" >> $env:GITHUB_STEP_SUMMARY
        "`n|-------|--------|`" >> $env:GITHUB_STEP_SUMMARY
        "`n| ðŸ§ª Tests | $(( '${{ needs.test.result }}' -eq 'success' ) ? 'âœ… Passed' : 'âŒ Failed' ) |`" >> $env:GITHUB_STEP_SUMMARY
        "`n| ðŸ—ï¸ Build | $(( '${{ needs.build.result }}' -eq 'success' ) ? 'âœ… Completed' : 'âŒ Failed' ) |`" >> $env:GITHUB_STEP_SUMMARY
        "`n| ðŸŽ¯ GitOps | ðŸ”„ ArgoCD Image Updater will handle deployment |`" >> $env:GITHUB_STEP_SUMMARY
        "`n`" >> $env:GITHUB_STEP_SUMMARY
        "`n### ðŸ”„ Next Steps:`" >> $env:GITHUB_STEP_SUMMARY
        "`n1. âœ… ArgoCD Image Updater detects new image`" >> $env:GITHUB_STEP_SUMMARY
        "`n2. âœ… Automatic Git commit with new image digest`" >> $env:GITHUB_STEP_SUMMARY
        "`n3. âœ… ArgoCD deploys automatically`" >> $env:GITHUB_STEP_SUMMARY