# ðŸš€ GITHUB ACTIONS - PIPELINE CI/CD COMPLETO
# Este workflow executa testes, build e deploy automÃ¡tico via GitOps

name: ðŸ—ï¸ Build and Deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'pom.xml'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]

env:
  # ðŸŽ¯ ConfiguraÃ§Ãµes do projeto
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx1024m'
  PROJECT_NAME: 'my-java-app'
  NAMESPACE: 'philippenunes-dev'

jobs:
  # ðŸ§ª TESTES E VALIDAÃ‡Ã•ES
  test:
    name: ðŸ§ª Tests & Quality Gates
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven

    - name: ðŸ§ª Run Tests
      run: |
        echo "ðŸ§ª Running unit tests..."
        mvn test
        echo "âœ… Tests completed - checking results..."
        
    - name: ðŸ“Š Test Report
      if: success() || failure()
      run: |
        echo "ðŸ“Š Test Results Summary:"
        if [ -f "target/surefire-reports/TEST-*.xml" ]; then
          echo "âœ… Test reports generated successfully"
          find target/surefire-reports -name "*.xml" -exec basename {} \;
        else
          echo "ðŸ“ No test reports found, but tests may have run successfully"
        fi

    - name: âœ… Code Coverage
      run: |
        echo "ðŸ“Š Generating coverage report..."
        mvn jacoco:report || echo "ðŸ“ Coverage plugin not configured"
        
  # ðŸ—ï¸ BUILD NO OPENSHIFT (apenas no main)
  build:
    name: ðŸ—ï¸ OpenShift Build
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Install OpenShift CLI
      run: |
        echo "ðŸ”§ Installing OpenShift CLI..."
        curl -LO https://github.com/openshift/okd/releases/download/4.13.0-0.okd-2023-09-16-012030/openshift-client-linux-4.13.0-0.okd-2023-09-16-012030.tar.gz
        tar -xzf openshift-client-linux-4.13.0-0.okd-2023-09-16-012030.tar.gz
        sudo mv oc kubectl /usr/local/bin/
        oc version --client
      
    - name: ðŸ” OpenShift Login
      run: |
        echo "ðŸ” Logging into OpenShift..."
        echo "Server: ${{ secrets.OPENSHIFT_SERVER }}"
        echo "Using token authentication..."
        
        # Verificar conectividade
        echo "ðŸŒ Testing connectivity..."
        curl -k --connect-timeout 10 ${{ secrets.OPENSHIFT_SERVER }}/healthz || echo "âš ï¸ Server may not be reachable"
        
        # Fazer login
        oc login --token=${{ secrets.OPENSHIFT_TOKEN }} --server=${{ secrets.OPENSHIFT_SERVER }} --insecure-skip-tls-verify=true
        
        # Verificar login
        echo "âœ… Login successful, checking user..."
        oc whoami
        
    - name: ðŸ—ï¸ Trigger Build
      run: |
        echo "ðŸ—ï¸ Starting OpenShift build..."
        echo "Project: ${{ env.PROJECT_NAME }}"
        echo "Namespace: ${{ env.NAMESPACE }}"
        
        # Verificar se o namespace existe
        oc get namespace ${{ env.NAMESPACE }} || echo "âš ï¸ Namespace may not exist"
        
        # Verificar se o BuildConfig existe
        oc get buildconfig ${{ env.PROJECT_NAME }} -n ${{ env.NAMESPACE }} || echo "âš ï¸ BuildConfig may not exist"
        
        # Iniciar o build
        oc start-build ${{ env.PROJECT_NAME }} -n ${{ env.NAMESPACE }} --follow --wait
        
    - name: ðŸ“¦ Get Latest Image
      id: image
      run: |
        echo "ðŸ“¦ Getting latest image digest..."
        BUILD_NUMBER=$(oc get builds -n ${{ env.NAMESPACE }} --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[-1].metadata.name}' | grep ${{ env.PROJECT_NAME }})
        echo "Latest build: $BUILD_NUMBER"
        echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
        
    - name: âœ… Build Success Notification
      run: |
        echo "âœ… Build completed successfully!"
        echo "ðŸ—ï¸ Build: ${{ steps.image.outputs.build_number }}"
        echo "ðŸŽ¯ Next: ArgoCD Image Updater will detect and deploy automatically"

  # ðŸ“Š DEPLOYMENT STATUS
  status:
    name: ðŸ“Š Deployment Status
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
    - name: ðŸ“Š Pipeline Summary
      run: |
        echo "## ðŸš€ Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ§ª Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ—ï¸ Build | ${{ needs.build.result == 'success' && 'âœ… Completed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŽ¯ GitOps | ðŸ”„ ArgoCD Image Updater will handle deployment |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”„ Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. âœ… ArgoCD Image Updater detects new image" >> $GITHUB_STEP_SUMMARY
        echo "2. âœ… Automatic Git commit with new image digest" >> $GITHUB_STEP_SUMMARY
        echo "3. âœ… ArgoCD deploys automatically" >> $GITHUB_STEP_SUMMARY