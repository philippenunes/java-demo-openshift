# 🚀 GITHUB ACTIONS - PIPELINE CI/CD COMPLETO
# Este workflow executa testes, build e deploy automático via GitOps

name: 🏗️ Build and Deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'pom.xml'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx1024m'
  PROJECT_NAME: 'my-java-app'
  NAMESPACE: 'philippenunes-dev'

jobs:
  # 🧪 TESTES E VALIDAÇÕES
  test:
    name: 🧪 Tests & Quality Gates
    runs-on: self-hosted
    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4

    - name: ☕ Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven

    - name: 🧪 Run Tests
      shell: powershell
      run: |
        Write-Host "🧪 Running unit tests..."
        mvn test
        Write-Host "✅ Tests completed successfully!"

    - name: ✅ Code Coverage
      shell: powershell
      run: |
        Write-Host "📊 Generating coverage report..."
        mvn jacoco:report -ErrorAction SilentlyContinue
        if ($LASTEXITCODE -ne 0) { Write-Host "📝 Coverage plugin not configured" }

  # 🏗️ BUILD NO OPENSHIFT (apenas no main)
  build:
    name: 🏗️ OpenShift Build
    runs-on: self-hosted
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
    - name: 📥 Checkout Code
      uses: actions/checkout@v4
        
    - name: ✅ Verify Environment
      shell: powershell
      run: |
        Write-Host "✅ Verifying self-hosted environment..."
        if (-not (Get-Command oc -ErrorAction SilentlyContinue)) {
          Write-Host "❌ OpenShift CLI not found - skipping OpenShift operations"
          exit 0
        }
        oc version --client
        try { oc whoami --show-server } catch { Write-Host "⚠️ Not logged into OpenShift" }
      
    - name: 🔐 OpenShift Login Check
      shell: powershell
      run: |
        Write-Host "🔐 Checking OpenShift connection..."
        try {
          $user = oc whoami 2>$null
          if ($user) { Write-Host "✅ Logged in as: $user" }
          else { Write-Host "⚠️ Not logged into OpenShift" }
        } catch { Write-Host "⚠️ Not logged into OpenShift" }

    - name: 🏗️ Trigger Build
      shell: powershell
      run: |
        Write-Host "🏗️ Starting OpenShift build..."
        Write-Host "Project: $env:PROJECT_NAME"
        Write-Host "Namespace: $env:NAMESPACE"

        try { oc get namespace $env:NAMESPACE } catch { Write-Host "⚠️ Namespace may not exist" }
        try { oc get buildconfig $env:PROJECT_NAME -n $env:NAMESPACE } catch { Write-Host "⚠️ BuildConfig may not exist" }

        oc start-build $env:PROJECT_NAME -n $env:NAMESPACE --follow --wait

    - name: 📦 Get Latest Image
      id: image
      shell: powershell
      run: |
        Write-Host "📦 Getting latest image digest..."
        $builds = oc get builds -n $env:NAMESPACE --sort-by=.metadata.creationTimestamp -o json
        $latestBuild = ($builds | ConvertFrom-Json).items[-1].metadata.name
        Write-Host "Latest build: $latestBuild"
        echo "build_number=$latestBuild" >> $env:GITHUB_OUTPUT

    - name: ✅ Build Success Notification
      shell: powershell
      run: |
        Write-Host "✅ Build completed successfully!"
        Write-Host "🏗️ Build: $($env:build_number)"
        Write-Host "🎯 Next: ArgoCD Image Updater will detect and deploy automatically"

  # 📊 DEPLOYMENT STATUS
  status:
    name: 📊 Deployment Status
    runs-on: self-hosted
    needs: build
    if: always()
    steps:
    - name: 📊 Pipeline Summary
      shell: powershell
      run: |
        "## 🚀 Pipeline Summary" >> $env:GITHUB_STEP_SUMMARY
        "| Stage | Status |" >> $env:GITHUB_STEP_SUMMARY
        "|-------|--------|" >> $env:GITHUB_STEP_SUMMARY
        "| 🧪 Tests | $(( ${{ needs.test.result }} -eq 'success') ? '✅ Passed' : '❌ Failed') |" >> $env:GITHUB_STEP_SUMMARY
        "| 🏗️ Build | $(( ${{ needs.build.result }} -eq 'success') ? '✅ Completed' : '❌ Failed') |" >> $env:GITHUB_STEP_SUMMARY
        "| 🎯 GitOps | 🔄 ArgoCD Image Updater will handle deployment |" >> $env:GITHUB_STEP_SUMMARY
        "" >> $env:GITHUB_STEP_SUMMARY
        "### 🔄 Next Steps:" >> $env:GITHUB_STEP_SUMMARY
        "1. ✅ ArgoCD Image Updater detects new image" >> $env:GITHUB_STEP_SUMMARY
        "2. ✅ Automatic Git commit with new image digest" >> $env:GITHUB_STEP_SUMMARY
        "3. ✅ ArgoCD deploys automatically" >> $env:GITHUB_STEP_SUMMARY